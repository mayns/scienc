<link rel="import" href="/static/elements/polymer/polymer.html"/>
<link rel="import" href="/static/elements/break-line.html"/>
<link rel="import" href="/static/elements/ajax-json-form.html"/>
<link rel="import" href="/static/elements/input-tags.html"/>
<link rel="import" href="/static/elements/core-overlay/core-overlay.html"/>
<link rel="import" href="/static/mixins.html"/>

<polymer-element name="project-modify" attributes="data" class="container main">
	<template>
		<style>
            :host {
                display: block;
            }
            .project-form section {
                color: #333;
            }
            .project-form fieldset {
                padding: 20px 20px 30px;
                margin-bottom: 40px;
                border: 1px solid #cccccc;
            }
            .project-form fieldset fieldset {
                border: none;
                margin-bottom: 0;
                padding-left: 0;
                padding-right: 0;
            }
            .project-form fieldset fieldset legend {
                font-size: 22px;
            }
            .project-form  legend {
                font-size: 30px;
            }
            .project-form  legend .icon {
                vertical-align: middle;
            }
            .icon {
                width: 20px;
                height: 20px;
                margin-left: 10px;
            }
			form {
				padding-bottom: 70px;
			}
			form .row-flex {
				margin-bottom: 20px;
			}
			form .row-flex:last-child {
				margin-bottom: 0;
			}
            .fieldblock {
                padding-left: 40px;
                position: relative;
            }
            .fieldblock + .fieldblock {
                padding-top: 40px;
                border-top: 1px solid #ccc;
                margin-top: 40px;
            }
            .deleteItem {
                position: absolute;
                top: 50%;
                left: 0;
                margin-top: -10px;
            }
            legend {
                font-size: 30px;
            }
            .missed-participants label {
                padding-right: 20px;
            }
		</style>
		<section vertical layout class="project-form">
			<form is="ajax-json-form"
                  id="form"
                  ajaxMethod="{{ ajaxMethod }}"
                  action="/api/project"
                  redirect="/">
                <template bind="{{ data }}">
                    <fieldset>
                        <legend>Общие сведения</legend>
                        <div class="row-flex fieldblock">
                            <div class="col-lg-12">
                                <div class="row-flex middle">
                                    <label for="title" class="action col-lg-3">Название проекта</label>
                                </div>
                                <div class="row-flex">
                                    <div class="col-lg-12">
                                        <input type="text"
                                               id="title"
                                               name="title"
                                               value="{{ title }}"
                                               data-json="title"
                                               required/>
                                    </div>
                                </div>
                                <div class="row-flex middle">
                                    <label class="action row-flex col-lg-12">Область науки</label>
                                </div>
                                <div class="row-flex">
                                    <div class="col-lg-12">
                                        <input type="text" id="researchFields" on-focus="{{ showResearchFields }}" value="{{ research_fields }}"/>
                                        <core-overlay id="researchFieldsDialog" on-core-overlay-close-completed="{{ onDialogClose }}" class="research-fields-dialog" layered backdrop>
                                            <div class="row-flex col-lg-12">
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/math.svg" alt=""/>
                                                    <label class="label action col-lg-10" for="math">Математика, информатика, механика</label>
                                                    <input class="checkbox" type="checkbox" value="math" id="math" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/physics.svg" alt=""/>
                                                    <label for="physics" class="action col-lg-10 label">Физика и астрономия</label>
                                                    <input class="checkbox" type="checkbox" value="physics" id="physics" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/chemistry.svg" alt=""/>
                                                    <label for="chemistry" class="action col-lg-10 label">Химия</label>
                                                    <input class="checkbox" type="checkbox" value="chemistry" id="chemistry" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/cs.svg" alt=""/>
                                                    <label for="it_science" class="action col-lg-10 label">Информационные технологии и вычеслительные системы</label>
                                                    <input class="checkbox" type="checkbox" value="it_science" id="it_science" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/biology.svg" alt=""/>
                                                    <label for="biology" class="action col-lg-10 label">Биология и медицинская наука</label>
                                                    <input class="checkbox" type="checkbox" value="biology" id="biology" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/earth.svg" alt=""/>
                                                    <label for="earth" class="action col-lg-10 label">Науки о Земле</label>
                                                    <input class="checkbox" type="checkbox" value="earth" id="earth" data-json="research_fields[]"/>
                                                </div>
                                                <div class="row-flex middle">
                                                    <img class="icon" src="/static/images/engineer.svg" alt=""/>
                                                    <label for="engeneering" class="action col-lg-10 label">Инженерные науки</label>
                                                    <input class="checkbox" type="checkbox" value="engeneering" id="engeneering" data-json="research_fields[]"/>
                                                </div>
                                            </div>    
                                        </core-overlay>
                                    </div>
                                </div>
                                <div class="row-flex middle">
                                    <label class="col-lg-3">В процессе</label>
                                    <input type="checkbox" checked="{{ in_progress !== 'false' }}" data-json="in_progress"/>
                                </div>
                                <div class="row-flex middle">
                                    <label class="col-lg-3">Связь с университетами</label>
                                    <input type="checkbox" checked="{{ university }}"/>
                                    <template if="{{ university }}">
                                        <img on-click="{{ addItem }}" data-itemtype="university_connection" class="action icon"
                                             src="/static/images/plus.svg"
                                             alt="" />
                                    </template>
                                </div>
                                <template if="{{ university }}">
                                    <template repeat="{{ university_connection }}">
                                        <div class="fieldblock">
                                            <div class="row-flex">
                                                <div class="col-lg-2">
                                                    <label for="">Страна</label>
                                                </div>
                                                <div class="col-lg-10">
                                                    <input type="text"
                                                           value="{{ country }}"
                                                           data-json="university_connection[][country]"/>
                                                </div>
                                            </div>
                                            <div class="row-flex">
                                                <div class="col-lg-2">
                                                    <label for="">Город</label>
                                                </div>
                                                <div class="col-lg-10">
                                                    <input type="text"
                                                           value="{{ city }}"
                                                           data-json="university_connection[][city]"/>
                                                </div>
                                            </div>
                                            <div class="row-flex">
                                                <div class="col-lg-2">
                                                    <label for="">Университет</label>
                                                </div>
                                                <div class="col-lg-10">
                                                    <input type="text"
                                                           value="{{ university }}"
                                                           data-json="university_connection[][university]"/>
                                                </div>
                                            </div>
                                            <div class="row-flex">
                                                <div class="col-lg-2">
                                                    <label for="">Факультет</label>
                                                </div>
                                                <div class="col-lg-10">
                                                    <input type="text"
                                                           value="{{ faculty }}"
                                                           data-json="university_connection[][faculty]"/>
                                                </div>
                                            </div>
                                            <div class="row-flex">
                                                <div class="col-lg-2">
                                                    <label for="">Кафедра</label>
                                                </div>
                                                <div class="col-lg-10">
                                                    <input type="text"
                                                           value="{{ chair }}"
                                                           data-json="university_connection[][chair]"/>
                                                </div>
                                            </div>
                                            <div class="row-flex"></div>
                                            <img class="deleteItem icon action"
                                                 data-itemtype="university_connection"
                                                 on-click="{{ deleteItem }}"
                                                 src="/static/images/minus.svg" alt=""/>
                                        </div>
                                    </template>
                                </template>
                                <div class="row-flex">
                                    <label for="description_short">Краткое описание</label>
                                </div>
                                <div class="row-flex">
                                    <textarea name="description_short"
                                          data-json="description_short"
                                          id="description_short"
                                          value="{{ description_short }}"
                                          class="col-lg-12" required></textarea>
                                </div>
                                <div class="row-flex">
                                    <label>Тэги</label>
                                </div>
                                <div class="row-flex">
                                    <input-tags value="{{ tags }}" class="col-lg-12" name="tags[]"></input-tags>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>О проекте</legend>
                        <div class="fieldblock">
                            <div class="row-flex">
                                <label class="action">Цели исследования</label>
                            </div>
                            <div class="row-flex">
                                <textarea name="objective"
                                          data-json="objective"
                                          value="{{ objective }}"
                                          id="objective"
                                          class="col-lg-12"></textarea>
                            </div>
                            <div class="row-flex">
                                <label>Полное описание</label>
                            </div>
                            <div class="row-flex">
                                <textarea name="description_full"
                                          data-json="description_full"
                                          value="{{ description_full }}"
                                          id="description_full"
                                          class="col-lg-12"></textarea>
                            </div>
                            <div class="row-flex">
                                <label>Возможности применения результатов</label>
                            </div>
                            <div class="row-flex">
                                <textarea name="usage_possibilities"
                                          data-json="usage_possibilities"
                                          value="{{ usage_possibilities }}"
                                          id="usage_possibilities"
                                          class="col-lg-12"></textarea>
                            </div>
                            <div class="row-flex">
                                <label>Достигнуты результаты</label>
                            </div>
                            <div class="row-flex">
                                <textarea name="results"
                                          data-json="results"
                                          value="{{ results }}"
                                          id="results"
                                          class="col-lg-12"></textarea>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Участники</legend>
                        <div class="fieldblock">
                            <div class="row-flex">
                                <label for="">Руководитель проекта</label>
                            </div>
                            <div class="row-flex">
                                <input name="leader"
                                       type="text"
                                       data-json="leader[full_name]"
                                       value="{{ leader.full_name }}"
                                       id="leader"
                                       class="col-lg-12">
                            </div>
                            <div class="row-flex middle">
                                <label for="">Участники проекта</label>
                                <img on-click="{{ addItem }}" data-itemtype="participants" class="action icon"
                                     src="/static/images/plus.svg"
                                     alt="" />
                            </div>
                            <template repeat="{{ participants }}">
                                <div class="row-flex">
                                    <div class="col-lg-4">
                                        <input type="text"
                                               value="{{ full_name }}"
                                               placeholder="ФИО"
                                               data-json="participants[][full_name]"/>
                                    </div>
                                    <div class="col-lg-4 col-lg-offset-1">
                                        <input type="text"
                                               value="{{ role_name }}"
                                               placeholder="Роль в проекте"
                                               data-json="participants[][role_name]"/>
                                    </div>
                                    <img on-click="{{ deleteItem }}"
                                         data-itemtype="participants"
                                         class="action icon"
                                         src="/static/images/minus.svg"
                                         alt="" />
                                </div>
                            </template>
                            <div class="row-flex">
                                <label for="">
                                    Разыскиваются
                                </label>
                                <img on-click="{{ addItem }}" data-itemtype="missed_participants" class="action icon"
                                     src="/static/images/plus.svg"
                                     alt="" />
                            </div>
                            <template repeat="{{ missed_participants }}">
                                <div class="row-flex">
                                    <div class="col-lg-4">
                                        <div class="row-flex between top">
                                            <input type="text"
                                                   placeholder="Должность"
                                                   value="{{ vacancy_name }}"
                                                   data-json="missed_participants[][vacancy_name]"
                                                   flex/>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-lg-offset-1">
                                            <textarea rows="1"
                                                      placeholder="Описание"
                                                      value="{{ description }}"
                                                      data-json="missed_participants[][description]"
                                                      flex></textarea>

                                    </div>
                                    <img on-click="{{ deleteItem }}" data-itemtype="missed_participants" class="action icon"
                                         src="/static/images/minus.svg"
                                         alt="" />
                                </div>
                            </template>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Контактные данные</legend>
                        <div class="fieldblock">
                            <div class="row-flex">
                                <label>
                                    Контакты
                                </label>
                                <img on-click="{{ addItem }}" data-itemtype="contacts" class="action icon"
                                     src="/static/images/plus.svg"
                                     alt="" />
                            </div>
                            <div class="row-flex">
                                <div class="col-lg-10">
                                    <template repeat="{{ contacts }}">
                                        <div class="row-flex between">
                                            <input type="text" class="col-lg-3" value="{{ name }}" data-json="contacts[][name]" placeholder="ФИО"/>
                                            <input type="text" class="col-lg-3" value="{{ type }}" data-json="contacts[][type]" placeholder="Тип"/>
                                            <input type="text" class="col-lg-3" value="{{ id }}" data-json="contacts[][id]" placeholder="Номер"/>
                                            <img on-click="{{ deleteItem }}" data-itemtype="contacts" class="action icon"
                                                 src="/static/images/minus.svg"
                                                 alt="" />
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!--<div class="row-flex">-->
                                <!--<label>Контактное лицо</label>-->
                            <!--</div>-->
                            <!--<div class="row-flex">-->
                                <!--<input type="text" class="col-lg-12" data-json="contact_manager"/>-->
                            <!--</div>-->
                        </div>
                    </fieldset>
                </template>
                <div class="row center">
                    <button type="submit" class="button submit">{{ viewType === 'create' ? 'Добавить' : 'Сохранить' }}</button>
                </div>
			</form>
		</section>
	</template>
    <script>
        Polymer('project-modify', Polymer.mixin({
            ready: function() {
                if (this.viewType === 'update') {
                    this.$.form.setAttribute('action', '/api/project/' + this.data.id);
                    this.$.form.redirect = '/project/' + this.data.id;
                }
            },
            publish: {
                data: {
                    university_connection: [1],
                    contacts: [1],
                    participants: [1],
                    missed_participants: [1]
                },
                formType: 'short',
                viewType: 'create'
            },
            onDialogClose: function() {
                var researchFields = $$.qsa('.checkbox',this.$.researchFieldsDialog)
                        .filter(function(item){
                            return item.checked;
                        })
                        .map(function(item){
                            return item.value;
                        });

                this.$.researchFields.value = researchFields;
            },
            showResearchFields: function() {
                this.$.researchFieldsDialog.open();    
            },
            computed: {
                ajaxMethod: "viewType === 'create' ? 'POST' : 'PUT'"
            }
        }, window.Mixins.dynamicFields));
    </script>
</polymer-element>