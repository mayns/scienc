<link rel="import" href="/static/elements/polymer/polymer.html"/>
<link rel="import" href="/static/elements/app-ajax.html"/>
<link rel="import" href="/static/elements/science-app.html"/>


<polymer-element name="project-missed-participant">
    <template>
        <style>
            :host {
                display: block;
                margin-bottom: 30px;
            }
            label {
                display: block;
                margin-bottom: 10px;
            }
            textarea {
                display: block;
                width: 100%;
                margin-bottom: 20px;
            }
            .vacancy {
                margin-bottom: 20px;
            }
        </style>
        <div layout horizontal center class="vacancy">
            <div flex>
                <div>{{ data.vacancy_name }}</div>
                <div class="meta">{{ data.description }}</div>
            </div>
            <template if="{{ !show_participate }}">
                <div on-tap="{{ toggleLetter }}" class="action">
                    Участвовать
                </div>
            </template>
            <template if="{{ show_participate }}">
                <div>
                     Заявка отправлена
                </div>
            </template>
        </div>
        <!--<template if="{{ show_participate }}">-->
            <!--<span>hi</span>-->
        <!--</template>-->
        <template if="{{ !show_participate }}">
            <div class="{{ letterPreview ? '' : 'hide' }} letter">
            <label for="">Прикрепить письмо к заявке</label>
            <textarea flex id="message"></textarea>
            <button class="button submit" on-tap="{{ submitForm }}">Отправить</button>
        </div>
        </template>
        <app-ajax id="ajax"
                  url="/api/project/{{ data.project_id }}/participation"
                  on-core-response="{{ onSubmitSuccess }}"
                  method="POST">
        </app-ajax>
    </template>
    <script>
        Polymer({
            ready: function(){
                this.app = ScienceApp;
                this.show_participate = this.app.user.desired_vacancies.indexOf(this.data.project_id + '_' + this.data.vacancy_id) !== -1;
            },
            publish: {
                data: {},
                letterPreview: false
            },
            toggleLetter: function() {
                this.letterPreview = !this.letterPreview;
            },
            submitForm: function() {
                var ajax = this.$.ajax;
                var formData = new FormData();
                var body = {
                    message: this.$.message.value,
                    vacancy_id: this.data.vacancy_id
                };
                formData.append('data', JSON.stringify(body));
                ajax.makeRequest(formData);
            },
            onSubmitSuccess: function(event, detail, sender) {
                this.$.message.value = '';
                this.letterPreview = false;
                this.show_participate = true;
                this.app.user.desired_vacancies.push(this.data.project_id + '_' + this.data.vacancy_id);
            }
        });
    </script>
</polymer-element>